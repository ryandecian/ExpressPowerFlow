version: "3.9"

services:
  nginx:
    image: nginx:1.27-alpine
    container_name: epf_nginx
    depends_on:
      - server
    ports:
      - "${DSM_PORT_CLIENT}:${VITE_PORT_CLIENT}"   # 60500:80 /  DSM fera 443 -> 60500 pour le front -> 80
    volumes:
      - /volume1/docker/ExpressPowerFlow/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - /volume1/docker/ExpressPowerFlow/client-dist:/usr/share/nginx/html:ro
      - /volume1/docker/ExpressPowerFlow/logs/nginx:/var/log/nginx
    restart: unless-stopped
    networks:
      - epf_net

  db:
    image: mariadb:11
    container_name: epf_db
    restart: always
    env_file: .env
    environment:
      - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD}
      - MYSQL_DATABASE=${DB_NAME}
      - MYSQL_USER=${DB_USER}
      - MYSQL_PASSWORD=${DB_PASSWORD}
      - TZ=Europe/Paris
    volumes:
      - db_data:/var/lib/mysql
      - /volume1/docker/ExpressPowerFlow/logs/db:/var/log/mysql
    expose:
      - "${DB_PORT}"  # seulement accessible entre services Docker
    # DEV uniquement : Exposition de la DB au net 
    ports:
      - "${DSM_PORT_DB_EXPOSITION}:${DB_PORT}"
    networks:
      - epf_net

  server:
    image: node:22-alpine
    container_name: epf_server
    restart: always
    ports:
      - "${DSM_PORT_API_SERVER}:${VITE_PORT_API_SERVER}"     # 7080:7080 / DSM proxy: 443 -> 7080 pour l'API
      - "${DSM_PORT_MQTT_BROKER}:${PORT_MQTT_BROKER}"  # 1883:1883 / DSM proxy: 1883 -> 1883 pour le broker MQTT
    working_dir: /app
    env_file: .env
    environment:
      - NODE_ENV=production
      - TZ=Europe/Paris

      # Domaines
      - VITE_DOMAIN_CLIENT=${VITE_DOMAIN_CLIENT}
      - VITE_DOMAIN_API_SERVER=${VITE_DOMAIN_API_SERVER}

      # Ports hors DB
      - VITE_PORT_API_SERVER=${VITE_PORT_API_SERVER} # Port interne docker. Le port externe dépend du reverse proxy

      # Variables de connexion DB
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME}

      # Variables de connexion au service gmail
      - MAIL_SERVER_ADMIN=${MAIL_SERVER_ADMIN}
      - MAIL_PASSWORD=${MAIL_PASSWORD}

      # Clés secrètes pour JWT
      - SECRET_KEY_TOKEN_CLIENT=${SECRET_KEY_TOKEN_CLIENT}
      - SECRET_KEY_TOKEN_API_SERVER=${SECRET_KEY_TOKEN_API_SERVER}
    volumes:
      - /volume1/docker/ExpressPowerFlow/server-dist:/app/dist:ro
      - /volume1/docker/ExpressPowerFlow/server-node_modules:/app/node_modules:ro
      - /volume1/docker/ExpressPowerFlow/server/uploads:/app/uploads
      - /volume1/docker/ExpressPowerFlow/logs/server:/app/logs
    depends_on:
      - db
    networks:
      - epf_net
    command: >
      sh -c "
      node --version &&
      node dist/index.js
      "

volumes:
  db_data:

networks:
  epf_net:
    driver: bridge
